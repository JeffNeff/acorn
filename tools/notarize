#!/bin/bash
set -e

cd $(dirname $0)/..

: ${NOTARIZE=""}

if [[ -z "${NOTARIZE}" && "$(uname)" == "Darwin" && "${GITHUB_REF}" =~ "refs/tags/v" ]]; then
  echo "Enabling notarize for tag"
  NOTARIZE="1"
fi

cp LICENSE README.md releases/mac_darwin_all/
if [[ -n "${NOTARIZE}" ]]; then
  echo "Notarizing"
  cp releases/mac_darwin_all/acorn releases/mac_darwin_all/acorn_orig

  which gon || (go install github.com/mitchellh/gon/cmd/gon@latest)

  gon .gon.hcl
else
  echo "Skipping notarizing"
  zip -j releases/mac_darwin_all/acorn.zip releases/mac_darwin_all/*
fi

mv releases/mac_darwin_all/acorn releases/mac_darwin_all/acorn_bin
cp releases/mac_darwin_all/acorn.zip releases/mac_darwin_all/acorn
